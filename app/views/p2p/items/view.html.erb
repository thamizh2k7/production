<% content_for :pagetitle  do %>
  <%=@item.title %> listed under <%= @item.product.name %>, <%=@item.category.name %>
<%end %>



<!-- if not logged in user or owner or admin show preview -->
<% if p2p_current_user.nil? or (p2p_current_user.id != @item.user.id and !session[:isadmin] ) %>

    <%= render "/p2p/items/preview_item"  %>

<% else %>

	<%= stylesheet_link_tag "items/items_manifest"%>
	                              

	<div class="main_wrapper">
	     <div class="row">
	         <div class="span6">
	         	 <!-- breadcumb -->
		          <ul class="breadcrumb">
			          <li>
			           	<a href="/p2p">P2P</a>
			           	<span class="divider">/</span>
			          </li>
			          <li>
			           	<a href="/p2p/<%=@item.category.name%>">
			           		<%=@item.category.name.titleize %></a>
			           		<span class="divider">/</span>
			          </li>
			          <li>
			           	<a  href="/p2p/<%=@item.category.name%>/<%=@item.product.name%>">
			           		<%=@item.product.name.titleize %>
			           	</a>
			          	<span class="divider">/</span>
			          </li>
			          <li class="active ">
			           	<%=link_to @item.title.titleize ,{:cat => @item.category.name ,:prod => @item.product.name ,:item => @item.title } %>
			          </li>
		          </ul>
		        </div>

	          <div class="span6">
							<div class="btn-group" id="listing_action">
	          		<!-- show the sold and not sold button based ont  -->
	          		<!-- for admin show the sold and not sold button based on the sold dat -->

	          		<!-- display the author button -->
	          		<%if session[:isadmin]%>
	          			<span class="btn action_popover" id="owner_item" data-title="<i class='icon-user'></i> Owner" data-content="The owner of this item is <%=@item.user.user.name%>(<%=@item.user.user.email%>)." data-placement="bottom" data-trigger="hover" data-html="true"><i class="icon-user"></i> Owner</span>
	          		<% end %>

		             <% if @item.solddate.nil?  %>
	                  <% if @item.approveddate.nil? %>
				                  <a href="#" class="  btn"  >
				                  	<i class=" action-icon icon-shopping-cart"  title="Listing has not been approved yet"></i>
				                   Waiting for approval
				                  </a>

				                  <%if session[:isadmin]%>
				                  	<button class="btn alert-info"  id="approve" itemid="<%=@item.id%>"><i  class="action-icon icon-thumbs-up" title="Approve this listing"></i></button>
			                  	<%end %>
		              	<% elsif @item.disapproveddate.nil? %>
			                  <!-- if admin display the approve button -->

			                  <a href="/p2p/sold/<%= @item.id %>" class=" btn"   >
			                  	<i class="  action-icon  icon-shopping-cart" title="Mark this listing as sold"></i> Mark as sold
			                  </a>

												<% if session[:isadmin]%>
			                  	<button class="btn alert-info" id="disapprove"   itemid="<%= @item.id %>"><i  class="icon-thumbs-down action-icon" title="DisApprove this listing"></i></button>
			                  <% end %>
                		<% else %>
			                  <a href="#" class="  btn"  >
			                  	<i class=" action-icon icon-ban-circle"  title="Disapproved"></i>
				                  	Disapproved
			                  </a>
             				<% end %>
             					<% if @item.user.id == p2p_current_user.id %>
	                  		<a href="<%=@payurl%>" id="payment_btn" class="btn action_popover" data-content="<%=@paytype_content%>" data-html="true" data-trigger="hover" data-dealy="{show:0,hide:500}" data-title="Payment Options" data-placement="bottom" >
		      	           	<i class="action-icon icon icon-gift" title="<%=@paytype_title%>"></i>
		    	              	Payment
	  		                </a>
	  		            	<% end %>
	  		            <% else %>
       									<span class="btn action_popover"  data-title="Listing Sold" data-content="On <%= @item.solddate.strftime("%d-%b-%C%y") %>"  data-trigger="hover" data-placement="bottom"> <i class="icon-shoppingcart"> </i> Listing Sold  </span>

		             		<% end %>
	           
	              <!-- check if the item is sold or not -->
	              	<% if @item.deletedate.nil? %>
		                <button class="btn"  id="delete_button"  itemid="<%=@item.id%>">
		                	<i  class=" action-icon icon-trash" title="Remove Listing"></i>
		                </button>
		            	<% else%>
		              
		              <button class="btn">
		               	<i  class=" action-icon icon-check" title="Deleted Listing"></i>
		              </button>
	              <% end %>

	              <%if @item.user.id == p2p_current_user.id%>
		              <button class="btn " id="enable">
		              	<i  class="action-icon icon-pencil"  title="Edit Listing"></i>
		              </button>

		              <button class="btn btn-success hide " id="save_top"  >
		              	<i  class=" action-icon icon-white icon-ok-circle" title="Save changes"></i> Save
		              </button>

		              <button class="btn btn-danger hide " id="cancel_top" >
		              	<i  class=" icon-white icon-remove-circle action-icon" title="Cancel changes"></i> Cancel
		              </button>

		              <a href="<%=@item_message_url%>" id="reqcount_<%=@item.id%>" role="button" class="btn " data-toggle="modal" ><i   class="action-icon icon-envelope" title="View Messages for this listing">  </i>  <%= @item.reqCount %> </a>
		            <% end %>

		            
	              <button class="btn" id="viewcount" ><i  title="Number of view of this listing" class="action-icon icon-eye-open"></i><%= @item.viewcount %></button>


	        </div> <!-- span6 action buttons-->
	      </div>
	    </div> <!-- row -->

	     <div class="row">
	        <div class="span4">
	          <ul class="thumbnails">
	        	  <li>
		            <div class="thumbnail">
		              <i id="clearuploads" class="icon-trash action-icon pull-right hidden" title="Clear pics uploaded just now" disabled="disabled">
		              </i>
		              <div id="upload_pic" title="Upload more photos" class="action-icon pull-right edit_visible"><i class="icon-upload"></i>Upload</div>

		              <div class="clearfix"></div>

		                <%= form_tag  "/p2p/items", :multipart => true, :id => "fileupload"   do %>
		                  <div id="form_temp"></div>
			                  <%= file_field_tag "img[]" ,:id=> "image_upload" ,:multiple  => 'true' ,:disabled => true  ,:accept => "image/*"  %>
		                <% end %>
				          <div id="view_image_holder">
				            <a href="<%=@fullimage[@rand_image][:url]%>" id="view_image_fancy">
				                 <img src="<%= @viewimage[@rand_image][:url] %>" imgid="<%= @viewimage[@rand_image][:id] %>" alt="Item pic" id="view_image">
				            </a>
				          </div>

				          <div class="caption thumb_holder">
				            <ul class="thumbnails">
				              <% i = 0 %>
				              <% @thumbimage.each do |img| %>
					              <li class="thumbs picture_upload_preview">
					                <i class="icon-remove pull-right remove_image hidden"></i>
				                  <img src="<%= img[:url]%>"  imgid="<%= img[:id] %>" alt="" id="image_<%= img[:id]%>" class="thumb_img" fancyimg="<%=@fullimage[i][:url]%>" viewimage="<%= @viewimage[i][:url] %>">
				                </li>
				              <% i += 1 %>
				              <% end %>
				            </ul>
				          </div>
		          	</div> <!-- thumbnail div -->
		      		</li>
	          </ul>
	        </div>

	        <div class="span6">
	          <center><code class="edit_visible"> All words in <span style="color:blue"> blue</span> are editable.Please click on them to edit</code></center>

	          <table class="table table-bordered table-striped" id="table_specs">
	            <colgroup>
	              <col class="span1">
	              <col class="span7">
	            </colgroup>
	             <thead>
	              <tr>
	                <th>Specification</th>
	                <th>Value</th>
	              </tr>
	            </thead>
	            <tbody>
	              <tr class="edit_visible">
	                <td>Title </td>
	                <td>
	                	<span class="canEdit action-icon" id="title"  data-original-title="Enter a title for your listing" data-placement="right" data-placeholder="Enter a title" ><%=@item.title.titleize  %></span>
	               	</td>
	              </tr>
	              <tr>
	                  <td>Category </td>
	                  <td> <span class=" action-icon" id="category_item" data-type="select" data-original-title="Select a category"  data-placement="right" data-placeholder="Select a category"   data-source="/p2p/getcategories" ><%=@item.category.name %></span></td>
	              </tr>
	              <tr>
	                <td>
	                	<%= (@item.category.name =="Books") ? 'Type' : 'Model'%>
	                </td>
	                <td>
	                	<span id="model" class="action-icon "  data-placement="right" data-placeholder="Select a model"  title="Select Model" data-type="select" >
	                		<%=@item.product.name%>
	                	</span>
	                </td>
	              </tr>
	              <!-- Price -->
	              <tr>
	                 <td>
	                   <span class="highlight">Price</span>
	                 </td>
	                 <td>
	                    <span class="highlight highlight_force_color">
	                    	Rs.
	                        <span class=" canEdit highlight action-icon  highlight_force_color" data-name="username"  title="Enter Price"   data-placement="right" data-placeholder="Enter the price"  specname="price" specid="0" id="price">
	                        	<%= @item.price %>
	                        </span>
	                    </span>
	                 </td>
	              </tr>
	            <!-- Location -->
	              <tr>
	                <td>
	                  <span class="highlight"> Condition</span>
	                </td>
	                <td>
	                  <span class=" canEdit highlight action-icon  highlight_force_color" data-name="username" data-type="select" data-source="['Brand New','Like New','Used','Old']" title="Enter Condition"  specname="condition" specid="0" id="condition"  data-placement="right" data-placeholder="Select the condition" > <%= @item.condition.titleize %> </span>
	                </td>
	              </tr>

	            <!-- Location -->
	              <tr>
	                <td>
	                  <span class="highlight">Location</span>
	                </td>
	                <td>
	              	  <span class="highlight canEdit action-icon highlight_force_color" data-name="username"  data-type="typeahead" data-source="/p2p/getcities"  title="Enter Location"  specname="location" specid="0" id="location"  data-placement="right" data-placeholder="Select the Location" >
	              	  	<%= @item.city.name %>
	              	  </span>
	                 </td>
	              </tr>

	              <!-- load some specs hree -->

	                <% spec_used = [] %>
	                <% @attr.limit(4).each do |aspec| %>
	                  <% spec_used.push(aspec.spec.id)%>
	                    <tr class="specs">
	                      <td>
	                        <%= aspec.spec.name %>
	                      </td>
	                      <td>
	                        <span class=" canEdit action-icon" data-name="username"  title="Enter <%= aspec.spec.name %>"  specname="<%= aspec.spec.name %>" specid="<%= aspec.spec.id.to_s %>" id="item_<%= aspec.spec.id %>" data-placement="right">
	                        	<%= aspec.value.titleize  unless aspec.value.nil? %>
	                        </span>
	                      </td>
	                    </tr>
	                  <% end %>


	              <!-- keep a check if we have shown all specs here or show more -->
	              <%if spec_used.size < @attr.size %>
	                <tr>
	                  <td colspan="2">
	                    <a href="#more_details">Click here to view more</a>
	                  </td>
	                </tr>
	              <% end %>
	            </tbody>
	          </table>
	        </div>
	     </div><!-- row ends -->


	     <div class="row">
	          <div id="desc" class="span10">
	               <h4> <%= @item.title.titleize %> Description</h4>
	               <span id="desc_content" title="Enter Description(More than 20 letters)" data-type="wysihtml5" class=" action-icon" inputclass="desc_content_form" data-wysihtml5="{image:false}"> <%= @item.desc.html_safe %> </span>
	          </div>

	     </div>

	     <!-- if we have more specs -->

			<% if spec_used.count < @attr.count %>

	        <div class="row">
	          <div class="span12" id="more_details">
	            <table class="table table-bordered table-striped">
	            <thead>
	              <tr>
	            	  <th class="span3">Specification</th>
	                <th>Value</th>
	              </tr>
	            </thead>
	            <tbody>
	           <!-- load remaining spec -->
              <% (spec_used.count..((@attr.count)-1)).each do |i| %>
              		<% spec_used.push(@attr[i].spec.id)%>
	                <tr>
	                  <td> <%= @attr[i].spec.name %> </td>
	                  <td>
	                    <span class="canEdit" data-name="username"  title="<%=@attr[i].value%>"  specname="<%= @attr[i].spec.name %>" specid="<%= @attr[i].spec.id.to_s %>" id="item_<%= @attr[i].spec.id %>" data-placement="right">
	                    	<%= @attr[i].value.titleize %>
	                    </span>
	                  </td>
	                </tr>
	            <% end %>
	            </tbody>
	          </table>
	        </div>
	      </div>
	    <% end %>
	 
	 		<!-- if we have more specs that are not yet used -->
	    <% if @item.product.category.specs.count > spec_used.count %>
	      <div id="add_more_spec" class="hide">
	        <b>Add More Specification here <br/></b>
	        <table class="table table-bordered table-striped hide" id="empty_specs">
	          <tr>
	            <th class="span3">Specification</th>
	            <th>Value</th>
	          </tr>
	          <% @item.product.category.specs.each do |spec| %>
	          	<!-- skipe if we have already loaded this spec -->
	            <% next if !spec_used.nil?  and spec_used.include?(spec.id) %>
	              <tr>
	                <td><%= spec.name %> </td>
	                <td>
	                  <span class="canEdit" data-name="<%=spec.name%>"  title="Enter <%=spec.name%>"  specname="<%= spec.name %>" specid="<%= spec.id.to_s %>" id="item_<%= spec.id %>" data-placement="right">  </span>
	                </td>
	              </tr>
	           <% end %>
	          </table>
	      </div>
	    <%end %>

    <div class="pull-right">
          <button class="btn btn-success hide " id="save_bottom"  >
          	<i  class=" action-icon icon-white icon-ok-circle" title="Save changes"></i> Save
          </button>

          <button class="btn btn-danger hide " id="cancel_bottom" >
          	<i  class=" icon-white icon-remove-circle action-icon" title="Cancel changes"></i> Cancel
          </button>

    </div>


</div>


	<script>

		window.item_id = '<%= @item.id%>';

	  window.editsaveurl = '/p2p/items/' + item_id;
	  window.editsavetype = "put";

	  window.image_count = <%= @viewimage.count %>;

	  window.item_values ={};
	  item_values['spec']={};

	  window.edit = true;

	  //load the values in the window namespace
	  //for edit
		item_values['title'] = "<%= @item.title %>";
		item_values['cat'] = "<%= @category_id %>";
		item_values['scat'] = "<%= @sub_category_id %>";
		item_values['brand'] = "<%= @brand_id %>";
		item_values['price'] = "<%= @item.price %>";
		item_values['condition'] = "<%= @item.condition %>";
		item_values['desc'] = $("#desc_content").html();
		item_values['location'] = "<%=@item.city.name%>";

	  <% @attr.each do |aspec| %>
	    item_values['spec']['<%= aspec.spec.id%>'] = "<%= aspec.value %>";
	  <% end %>
	</script>
<% end %>

<%= javascript_include_tag 'p2p/item/common' %>
<%= javascript_include_tag 'p2p/item/items' %>
<%= javascript_include_tag 'p2p/item/view' %>

<script>
$(document).ready(function(){
		$('.action-icon').tooltip('destroy');
});
</script>