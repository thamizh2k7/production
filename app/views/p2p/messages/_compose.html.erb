


<div id="compose_form_holder">
	<div id="compose_form_title">

		<% if defined? class_name  %>

		<% else %>
			<%class_name = "" %>
		<% end %>

	<%= form_for message ,:validate => true  , :html => {:class => "form-horizontal #{class_name}"}, :remote => true  do |f| %>


			<%= f.hidden_field :parent_id ,:readonly => true  %>
			<% if defined? toany and toany %>
				<%= f.text_field :receiver_id %>
			<% elsif defined? admin and admin %>
				<%= f.hidden_field :receiver_id, :value => "1" ,:readonly => true  %>
			<% elsif defined? ownerid  %>
				<%= f.hidden_field :receiver_id, :value => ownerid ,:readonly => true  %>
				<%= f.hidden_field :item_id, :value => itemid ,:readonly => true  %>
				<%= f.hidden_field :from,  :value =>  "view" %>
			<%else %>
				<%= f.hidden_field :receiver_id, :value => "1" ,:readonly => true  %>
			<% end %>

		<!-- 1 - admin mesage
		2- buy request 
		0 - reply
		 -->
		<% if defined? admin and admin %>
		 	<%= f.hidden_field :messagetype, :value => 1 %>
		<% elsif defined? ownerid %>
			<%= f.hidden_field :messagetype,  :value =>  2 %>
	 	<% else %>
	 		<%= f.hidden_field :messagetype,  :value => 0 %>
	 	<% end %>

	 	
		<div class="control-group">
			<%= f.label :message  ,"Personal Message", :class=> 'control-label' %>
	 		<div class="controls"><%= f.text_area :message, :rows => 6,:cols => 25 %> 		</div>
	 	</div>

		<div class="control-group">

	 		<div class="controls"><%= f.submit :submit, value:"Send Message" ,:id => "message_submit " , :class => "btn btn-primary"  %></div>
	 	</div>

	 <% end %>
	</div>
</div>


<script>

	$(document).ready(function(){

		<% if class_name == '' %>
			var obj = "#new_p2p_message"
		<% else %>
			var obj = "<%=class_name%>";
		<% end %>

		
		$('#message_submit').on('submit',function(){
			$("#compose_newmsg_modal .close").trigger('click');
			$("#reply_to_modal .close").trigger('click');
			showNotifications("Sending your message");
			$(obj).submit();
			return false;
		});

		<% if defined? toany and toany %>

		window.cache={}

	    $("#p2p_message_receiver_id").autocomplete({
	      minLength: 2,
	      source: function( request, response ) {
	        var term = request.term;
	        if ( term in cache ) {
	          response( cache[ term ] );
	          return;
	        }

			$.ajax({
				url:'/p2p/users/list',
				data:{q:term},
				dataType:"json",
				type:'post',
				success:function(data){
		          cache[ term ] = data;
          			response( data );

				}
			});

	      },
	      select:function(event,elem){
	          
	      },
	      focus:function(){
	        
	      }
	    });

		<% end %>
	});

</script>